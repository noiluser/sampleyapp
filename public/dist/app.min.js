var app=angular.module("yaSample",["ngRoute","ngCookies","ui.bootstrap"]);app.config(["$routeProvider","$locationProvider",function(t,e){t.when("/",{templateUrl:"static/tmpl/start.html",controller:"StartController"}).when("/disk",{templateUrl:"static/tmpl/explorer.html",controller:"ExplorerController"}).when("/disk/:path*",{templateUrl:"static/tmpl/explorer.html",controller:"ExplorerController"}),e.html5Mode(!0)}]),app.directive("authDirective",function(){return{templateUrl:"static/tmpl/authDirective.html"}}),app.directive("navDirective",function(){return{templateUrl:"static/tmpl/navDirective.html"}}),app.controller("ExplorerController",["$scope","$routeParams","$location","User",function(t,e,n,o){"ngInject";t.items=[],t.isContentLoaded=!1,t.isError=!1,e.path?t.path=e.path:t.path="",t.$watch(function(){return o.isAuthorized()},function(e,n){e?(t.$emit("loadFolder"),t.isError=!1,t.message=""):(t.message="Access denied. Please login.",t.isError=!0)}),t.$on("loadFolder",function(e){o.getContent(t.path).then(function(e){t.isContentLoaded=!0,e.hasOwnProperty("_embedded")&&(t.items=e._embedded.items),t.items.forEach(function(t){t.preview?t.preview=t.preview.slice(0,-1)+"1":t.preview="static/img/"+t.type+".png"})},function(e){t.isError=!0,t.message=e.message})}),t.navigate=function(t,e){if(e&&"dir"==e){var o="/disk/"+t;n.path(o)}}}]),app.controller("AuthController",["$scope","$location","$window","$http","User",function(t,e,n,o,r){"ngInject";t.paramsToString=t.$parent.paramsToString;var a=e.search().code;a?r.setCode(a).then(function(t){e.search("code",null)}):r.checkCookiesToken(),t.openTop=function(){e.path("/")},t.openProfile=function(){n.open("https://passport.yandex.ru/profile","_blank")},t.$watch(function(){return r.isAuthorized()},function(e){t.isUserLoggedIn=e}),t.$watch(function(){return r.getPhoto()},function(e){t.photo="https://avatars.yandex.net/get-yapic/"+e+"/islands-middle"}),t.$watch(function(){return r.hasPhoto()},function(e){t.hasPhoto=e}),t.$watch(function(){return r.getName()},function(e){t.userName=e}),t.login=function(){o.get("/clientid").then(function(e){var o={response_type:"code",client_id:e.data.client_id,device_id:"",device_name:"",login_hint:"",force_confirm:"yes",state:""};n.open("https://oauth.yandex.ru/authorize?"+t.paramsToString(o),"_self")})},t.logout=function(){r.resetParams().then(function(t){t.isLoggedOut&&(r.clearCookies(),e.path("/"))})}}]),app.controller("MainController",["$scope",function(t){"ngInject";t.paramsToString=function(t,e,n){var o="";for(var r in t)o+=r+"="+t[r],o+=n?n:"&";return e&&(o=o.substring(0,o.length-1)),o}}]),app.controller("NavController",["$scope","$routeParams","$location","User",function(t,e,n,o){"ngInject";t.$watch(function(){return o.isAuthorized()},function(e){e?t.isUserLoggedIn=!0:t.isUserLoggedIn=!1}),t.paths=[],e.path?(t.path=e.path,t.paths=e.path.split("/")):t.path="",t.navigateByIndex=function(e){if(e<t.paths.length){for(var o="",r=0;r<=e;r++)o+="/"+t.paths[r];n.path("/disk"+o)}else console.log("error: index="+e+" is out of bounds (path length is "+t.paths.length+")")}}]),app.controller("StartController",["$scope","$location","$window","$http","$cookies","User",function(t,e,n,o,r,a){"ngInject";t.$watch(function(){return a.isAuthorized()},function(e){t.isUserLoggedIn=e})}]),app.filter("cutDisk",function(){return function(t){return t.replace(/^(disk\:\/)/,"")}}),app.filter("normalizedSize",function(){return function(t){if(t){var e="";t=1*t;var n=2;0==t&&(e="(0 Bytes)");var o=1024,r=n+1||3,a=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"],i=Math.floor(Math.log(t)/Math.log(o));return e=parseFloat((t/Math.pow(o,i)).toFixed(r))+" "+a[i]}return""}}),app.factory("User",["$http","$q","$cookies",function(t,e,n){var o=new Object,r=new Object;return o.checkCookiesToken=function(){var t=n.get("YaDiskAccess");if(t)return r.token=t,r.getUserData();var o=e.defer();return o.reject(),o.promise},o.setCode=function(t){return r.getTokenByCode(t)},o.resetParams=function(){var t=e.defer();return r.isAuthorized=!1,r.name="",r.hasPhoto=!1,r.photo="",t.resolve({isLoggedOut:!0}),t.promise},o.clearCookies=function(){n.remove("YaDiskAccess")},o.getContent=function(t){return r.request(t)},o.isAuthorized=function(){return r.isAuthorized},o.getName=function(){return r.name},o.hasPhoto=function(){return r.hasPhoto},o.getPhoto=function(){return r.photo},r.getTokenByCode=function(o){var a={host:"oauth.yandex.ru",path:"/token",method:"POST",params:{code:o}},i=e.defer();return t.post("/login",a).then(function(t){return t.data.access_token?(r.token=t.data.access_token,n.put("YaDiskAccess",r.token),r.getUserData()):(i.reject(t),i.promise)},function(t){return i.reject(t),i.promise})},r.getUserData=function(){var e={host:"login.yandex.ru",path:"/info",method:"POST",headers:{Authorization:"OAuth "+r.token}};return t.post("/request",e).then(function(t){r.name=t.data.display_name,r.hasPhoto=!0,r.photo=t.data.default_avatar_id,r.isAuthorized=!0})},r.request=function(n){n||(n="");var o={host:"cloud-api.yandex.net",path:"/v1/disk/resources?limit=999999&path=disk:/",method:"GET",navigate:n,headers:{Authorization:"OAuth "+r.token}},a=e.defer();return t.post("/navigate",o).then(function(t){t.data.hasOwnProperty("error")?a.reject(t.data):a.resolve(t.data)},function(t){a.reject(t)}),a.promise},o.resetParams(),o}]);